buildscript {
    repositories {
        maven { url = 'https://repo.spongepowered.org/repository/maven-public/' }
        maven { url = 'https://plugins.gradle.org/m2/' }
        mavenCentral()
		mavenLocal()
    }
    dependencies {
        classpath group: 'com.diffplug.gradle', name: 'goomph', version: '3.35.0'
        classpath group: 'org.spongepowered', name: 'mixingradle', version: '0.7-SNAPSHOT-fix'
    }
}

plugins {
    id 'fabric-loom' version '0.12-SNAPSHOT'
    id 'com.github.johnrengelman.shadow' version '7.1.0'
}

apply plugin: 'eclipse'
apply plugin: 'com.diffplug.eclipse.apt'
apply plugin: 'org.spongepowered.mixin'

version = '1.18.2-1.0.0'
group = 'net.enderturret'
archivesBaseName = 'Patched'

java.toolchain.languageVersion = JavaLanguageVersion.of(17)

mixin {
	add sourceSets.main, 'patched.refmap.json'
}

// TODO Try to fix refmap being omitted from shadowJar

/*sourceSets.main {
    ext.refMap = 'patched.refmap.json'
}*/

repositories {
    maven { url = 'https://maven.parchmentmc.org' }
	mavenLocal()
}

dependencies {
    minecraft 'com.mojang:minecraft:1.18.2'
    mappings loom.layered() {
        officialMojangMappings()
        parchment('org.parchmentmc.data:parchment-1.18.2:2022.05.02@zip')
    }
    modImplementation 'net.fabricmc:fabric-loader:0.14.8'

	modImplementation ('net.enderturret:Patched:1.0.2') {
		exclude group: 'com.google.code.gson', module: 'gson'
	}

    annotationProcessor 'org.spongepowered:mixin:0.8.5:processor'
}

shadowJar {
    classifier 'all'

    dependencies {
        include(dependency('net.enderturret:Patched:1.0.2'))
    }
}

artifacts {
    archives shadowJar
}

afterEvaluate {
    reobf {
        shadowJar {
            mappings = createMcpToSrg.output
        }
    }
}

processResources {
    inputs.property 'version', project.version

    filesMatching('fabric.mod.json') {
        expand 'version': project.version
    }
}

jar {
    manifest {
        attributes([
            'Specification-Title': 'Patched',
            'Specification-Vendor': 'EnderTurret',
            'Specification-Version': '1',
            'Implementation-Title': 'Patched',
            'Implementation-Version': "${version}",
            'Implementation-Vendor' : 'EnderTurret',
            'Implementation-Timestamp': new Date().format("yyyy-MM-dd'T'HH:mm:ssZ"),
			'MixinConfigs': 'mixins.patched.json'
        ])
    }
}

//jar.finalizedBy('reobfJar')
jar.finalizedBy('reobfShadowJar')
shadowJar.finalizedBy('reobfShadowJar')
//shadowJar.finalizedBy('reobfJar')

// Compact JSON files for smol jars.

import groovy.json.*

processResources {
    doLast {
        fileTree(dir: outputs.files.asPath, include: '**/*.json').each {
            File file -> file.text = JsonOutput.toJson(new JsonSlurper().parse(file))
        }
    }
}